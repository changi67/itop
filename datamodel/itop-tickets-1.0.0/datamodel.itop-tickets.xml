<?xml version="1.0" encoding="UTF-8"?>
<classes>
  <class name="Ticket" category="bizmodel,searchable" parent="cmdbAbstractObject" abstract="true" key_type="autoincrement" db_table="ticket" db_key_field="id" db_final_class_field="finalclass">
    <properties>
      <comment><![CDATA[/**
 * Persistent classes for a CMDB
 *
 * @author      Erwan Taloc <erwan.taloc@combodo.com>
 * @author      Romain Quetiez <romain.quetiez@combodo.com>
 * @author      Denis Flaven <denis.flaven@combodo.com>
 * @license     http://www.opensource.org/licenses/gpl-3.0.html LGPL
 */]]></comment>
      <naming format="%1$s">
        <attributes>
          <attribute name="ref"/>
        </attributes>
      </naming>
      <display_template></display_template>
      <icon></icon>
      <reconciliation>
        <attributes>
          <attribute name="ref"/>
        </attributes>
      </reconciliation>
    </properties>
    <fields>
      <field name="ref" type="String" sql="ref" default_value="" is_null_allowed="true"/>
      <field name="title" type="String" sql="title" default_value="" is_null_allowed="false"/>
      <field name="description" type="Text" sql="description" default_value="" is_null_allowed="false"/>
      <field name="ticket_log" type="CaseLog" sql="ticket_log" default_value="" is_null_allowed="true"/>
      <field name="start_date" type="DateTime" sql="start_date" default_value="" is_null_allowed="false"/>
      <field name="document_list" type="LinkedSetIndirect" linked_class="lnkTicketToDoc" ext_key_to_me="ticket_id" ext_key_to_remote="document_id" count_min="0" count_max="0"/>
      <field name="ci_list" type="LinkedSetIndirect" linked_class="lnkTicketToCI" ext_key_to_me="ticket_id" ext_key_to_remote="ci_id" count_min="0" count_max="0"/>
      <field name="contact_list" type="LinkedSetIndirect" linked_class="lnkTicketToContact" ext_key_to_me="ticket_id" ext_key_to_remote="contact_id" count_min="0" count_max="0"/>
      <field name="incident_list" type="LinkedSetIndirect" linked_class="lnkTicketToIncident" ext_key_to_me="ticket_id" ext_key_to_remote="incident_id" count_min="0" count_max="0"/>
    </fields>
    <methods/>
    <presentation>
      <details>
        <items>
          <item>ref</item>
          <item>title</item>
          <item>description</item>
          <item>start_date</item>
          <item>document_list</item>
          <item>ci_list</item>
          <item>contact_list</item>
          <item>incident_list</item>
        </items>
      </details>
      <search>
        <items>
          <item>finalclass</item>
          <item>ref</item>
          <item>title</item>
          <item>start_date</item>
        </items>
      </search>
      <list>
        <items>
          <item>finalclass</item>
          <item>ref</item>
          <item>title</item>
          <item>ticket_log</item>
          <item>start_date</item>
        </items>
      </list>
    </presentation>
  </class>
  <class name="ResponseTicket" category="bizmodel" parent="Ticket" abstract="true" key_type="autoincrement" db_table="ticket_response" db_key_field="id" db_final_class_field="">
    <properties>
      <naming format="%1$s">
        <attributes>
          <attribute name="ref"/>
        </attributes>
      </naming>
      <display_template></display_template>
      <icon></icon>
      <reconciliation>
        <attributes>
          <attribute name="ref"/>
        </attributes>
      </reconciliation>
    </properties>
    <fields>
      <field name="status" type="Enum" sql="status" default_value="new" is_null_allowed="false">
        <values>
          <value>new</value>
          <value>assigned</value>
          <value>frozen</value>
          <value>escalated_tto</value>
          <value>escalated_ttr</value>
          <value>resolved</value>
          <value>closed</value>
        </values>
      </field>
      <field name="caller_id" type="ExternalKey" target_class="Person" jointype="" filter="SELECT Person WHERE org_id = :this-&gt;org_id" sql="caller_id" is_null_allowed="true" on_target_delete="DEL_MANUAL">
        <dependencies>
          <attribute name="org_id"/>
        </dependencies>
      </field>
      <field name="caller_email" type="ExternalField" extkey_attcode="caller_id" target_attcode="email"/>
      <field name="org_id" type="ExternalKey" target_class="Organization" jointype="" sql="org_id" is_null_allowed="false" on_target_delete="DEL_AUTO"/>
      <field name="org_name" type="ExternalField" extkey_attcode="org_id" target_attcode="name"/>
      <field name="service_id" type="ExternalKey" target_class="Service" jointype="" filter="SELECT Service AS s JOIN SLA AS sla ON sla.service_id=s.id JOIN lnkContractToSLA AS ln ON ln.sla_id=sla.id JOIN CustomerContract AS cc ON ln.contract_id=cc.id WHERE cc.org_id =:this-&gt;org_id" sql="service_id" is_null_allowed="false" on_target_delete="DEL_MANUAL">
        <dependencies>
          <attribute name="org_id"/>
        </dependencies>
      </field>
      <field name="service_name" type="ExternalField" extkey_attcode="service_id" target_attcode="name"/>
      <field name="servicesubcategory_id" type="ExternalKey" target_class="ServiceSubcategory" jointype="" filter="SELECT ServiceSubcategory WHERE service_id = :this-&gt;service_id" sql="servicesubcategory_id" is_null_allowed="false" on_target_delete="DEL_MANUAL">
        <dependencies>
          <attribute name="service_id"/>
        </dependencies>
      </field>
      <field name="servicesubcategory_name" type="ExternalField" extkey_attcode="servicesubcategory_id" target_attcode="name"/>
      <field name="product" type="String" sql="product" default_value="" is_null_allowed="true"/>
      <field name="impact" type="Enum" sql="impact" default_value="1" is_null_allowed="false">
        <values>
          <value>1</value>
          <value>2</value>
          <value>3</value>
        </values>
      </field>
      <field name="urgency" type="Enum" sql="urgency" default_value="1" is_null_allowed="false">
        <values>
          <value>1</value>
          <value>2</value>
          <value>3</value>
        </values>
      </field>
      <field name="priority" type="Enum" sql="priority" default_value="1" is_null_allowed="false">
        <values>
          <value>1</value>
          <value>2</value>
          <value>3</value>
        </values>
      </field>
      <field name="workgroup_id" type="ExternalKey" target_class="Team" jointype="" filter="SELECT Team AS t JOIN CustomerContract AS cc ON cc.support_team_id=t.id JOIN lnkContractToSLA AS ln ON ln.contract_id=cc.id JOIN SLA AS sla ON ln.sla_id=sla.id WHERE sla.service_id = :this-&gt;service_id AND cc.org_id = :this-&gt;org_id" sql="workgroup_id" is_null_allowed="false" on_target_delete="DEL_MANUAL">
        <dependencies>
          <attribute name="org_id"/>
          <attribute name="service_id"/>
        </dependencies>
      </field>
      <field name="workgroup_name" type="ExternalField" extkey_attcode="workgroup_id" target_attcode="name"/>
      <field name="agent_id" type="ExternalKey" target_class="Person" jointype="" filter="SELECT Person AS p JOIN lnkTeamToContact AS l ON l.contact_id=p.id JOIN Team AS t ON l.team_id=t.id WHERE t.id = :this-&gt;workgroup_id" sql="agent_id" is_null_allowed="true" on_target_delete="DEL_MANUAL">
        <dependencies>
          <attribute name="workgroup_id"/>
        </dependencies>
      </field>
      <field name="agent_name" type="ExternalField" extkey_attcode="agent_id" target_attcode="name"/>
      <field name="agent_email" type="ExternalField" extkey_attcode="agent_id" target_attcode="email"/>
      <field name="related_problem_id" type="ExternalKey" target_class="Problem" jointype="" sql="related_problem_id" is_null_allowed="true" on_target_delete="DEL_MANUAL"/>
      <field name="related_problem_ref" type="ExternalField" extkey_attcode="related_problem_id" target_attcode="ref"/>
      <field name="related_change_id" type="ExternalKey" target_class="Change" jointype="" sql="related_change_id" is_null_allowed="true" on_target_delete="DEL_MANUAL"/>
      <field name="related_change_ref" type="ExternalField" extkey_attcode="related_change_id" target_attcode="ref"/>
      <field name="close_date" type="DateTime" sql="close_date" default_value="" is_null_allowed="true"/>
      <field name="last_update" type="DateTime" sql="last_update" default_value="" is_null_allowed="true"/>
      <field name="assignment_date" type="DateTime" sql="assignment_date" default_value="" is_null_allowed="true"/>
      <field name="resolution_date" type="DateTime" sql="resolution_date" default_value="" is_null_allowed="true"/>
      <field name="tto_escalation_deadline" type="Deadline" sql="tto_escalation_deadline" default_value="" is_null_allowed="true"/>
      <field name="ttr_escalation_deadline" type="Deadline" sql="ttr_escalation_deadline" default_value="" is_null_allowed="true"/>
      <field name="closure_deadline" type="Deadline" sql="closure_deadline" default_value="" is_null_allowed="true"/>
      <field name="resolution_code" type="Enum" sql="resolution_code" default_value="fixed" is_null_allowed="true">
        <values>
          <value>fixed</value>
          <value>duplicate</value>
          <value>couldnotreproduce</value>
          <value>irrelevant</value>
        </values>
      </field>
      <field name="solution" type="Text" sql="solution" default_value="" is_null_allowed="true"/>
      <field name="user_satisfaction" type="Enum" sql="user_satisfaction" default_value="1" is_null_allowed="true">
        <values>
          <value>1</value>
          <value>2</value>
          <value>3</value>
          <value>4</value>
        </values>
      </field>
      <field name="user_commment" type="Text" sql="user_commment" default_value="" is_null_allowed="true"/>
    </fields>
    <lifecycle attribute="status">
      <stimuli>
        <stimulus name="ev_assign" type="StimulusUserAction"/>
        <stimulus name="ev_reassign" type="StimulusUserAction"/>
        <stimulus name="ev_timeout" type="StimulusInternal"/>
        <stimulus name="ev_resolve" type="StimulusUserAction"/>
        <stimulus name="ev_close" type="StimulusUserAction"/>
      </stimuli>
      <states>
        <state name="new">
          <flags>
            <attribute name="ref" read_only="1"/>
            <attribute name="title"/>
            <attribute name="description" must_change="1"/>
            <attribute name="ticket_log"/>
            <attribute name="start_date" read_only="1"/>
            <attribute name="document_list"/>
            <attribute name="ci_list"/>
            <attribute name="contact_list"/>
            <attribute name="incident_list"/>
            <attribute name="status"/>
            <attribute name="caller_id" mandatory="1"/>
            <attribute name="caller_email"/>
            <attribute name="org_id" must_change="1"/>
            <attribute name="org_name"/>
            <attribute name="service_id" must_change="1"/>
            <attribute name="service_name"/>
            <attribute name="servicesubcategory_id" must_change="1"/>
            <attribute name="servicesubcategory_name"/>
            <attribute name="product" must_prompt="1"/>
            <attribute name="impact" must_change="1"/>
            <attribute name="urgency" must_change="1"/>
            <attribute name="priority" read_only="1"/>
            <attribute name="workgroup_id" must_change="1"/>
            <attribute name="workgroup_name"/>
            <attribute name="agent_id"/>
            <attribute name="agent_name"/>
            <attribute name="agent_email" hidden="1"/>
            <attribute name="related_problem_id" hidden="1"/>
            <attribute name="related_problem_ref"/>
            <attribute name="related_change_id" hidden="1"/>
            <attribute name="related_change_ref"/>
            <attribute name="close_date" hidden="1"/>
            <attribute name="last_update" read_only="1"/>
            <attribute name="assignment_date" hidden="1"/>
            <attribute name="resolution_date" hidden="1"/>
            <attribute name="tto_escalation_deadline" read_only="1"/>
            <attribute name="ttr_escalation_deadline" hidden="1"/>
            <attribute name="closure_deadline" hidden="1"/>
            <attribute name="resolution_code" hidden="1"/>
            <attribute name="solution" hidden="1"/>
            <attribute name="user_satisfaction" hidden="1"/>
            <attribute name="user_commment" hidden="1"/>
            <attribute name="related_change_id_finalclass_recall"/>
          </flags>
          <transitions>
            <transition stimulus="ev_assign" target="assigned">
              <actions>
                <action verb="SetAssignedDate"/>
              </actions>
            </transition>
            <transition stimulus="ev_timeout" target="escalated_tto">
              <actions/>
            </transition>
          </transitions>
        </state>
        <state name="escalated_tto">
          <flags>
            <attribute name="ref" read_only="1"/>
            <attribute name="title"/>
            <attribute name="description"/>
            <attribute name="ticket_log"/>
            <attribute name="start_date" read_only="1"/>
            <attribute name="document_list"/>
            <attribute name="ci_list"/>
            <attribute name="contact_list"/>
            <attribute name="incident_list"/>
            <attribute name="status"/>
            <attribute name="caller_id" mandatory="1"/>
            <attribute name="caller_email"/>
            <attribute name="org_id"/>
            <attribute name="org_name"/>
            <attribute name="service_id"/>
            <attribute name="service_name"/>
            <attribute name="servicesubcategory_id"/>
            <attribute name="servicesubcategory_name"/>
            <attribute name="product"/>
            <attribute name="impact"/>
            <attribute name="urgency"/>
            <attribute name="priority" read_only="1"/>
            <attribute name="workgroup_id"/>
            <attribute name="workgroup_name"/>
            <attribute name="agent_id"/>
            <attribute name="agent_name"/>
            <attribute name="agent_email" hidden="1"/>
            <attribute name="related_problem_id" hidden="1"/>
            <attribute name="related_problem_ref"/>
            <attribute name="related_change_id" hidden="1"/>
            <attribute name="related_change_ref"/>
            <attribute name="close_date" hidden="1"/>
            <attribute name="last_update" read_only="1"/>
            <attribute name="assignment_date" hidden="1"/>
            <attribute name="resolution_date" hidden="1"/>
            <attribute name="tto_escalation_deadline" read_only="1"/>
            <attribute name="ttr_escalation_deadline" hidden="1"/>
            <attribute name="closure_deadline" hidden="1"/>
            <attribute name="resolution_code" hidden="1"/>
            <attribute name="solution" hidden="1"/>
            <attribute name="user_satisfaction" hidden="1"/>
            <attribute name="user_commment" hidden="1"/>
            <attribute name="related_change_id_finalclass_recall"/>
          </flags>
          <transitions>
            <transition stimulus="ev_assign" target="assigned">
              <actions>
                <action verb="SetAssignedDate"/>
              </actions>
            </transition>
          </transitions>
        </state>
        <state name="assigned">
          <flags>
            <attribute name="ref" read_only="1"/>
            <attribute name="title" read_only="1"/>
            <attribute name="description" read_only="1"/>
            <attribute name="ticket_log"/>
            <attribute name="start_date" read_only="1"/>
            <attribute name="document_list"/>
            <attribute name="ci_list"/>
            <attribute name="contact_list"/>
            <attribute name="incident_list"/>
            <attribute name="status"/>
            <attribute name="caller_id" read_only="1"/>
            <attribute name="caller_email"/>
            <attribute name="org_id" read_only="1"/>
            <attribute name="org_name"/>
            <attribute name="service_id"/>
            <attribute name="service_name"/>
            <attribute name="servicesubcategory_id"/>
            <attribute name="servicesubcategory_name"/>
            <attribute name="product"/>
            <attribute name="impact"/>
            <attribute name="urgency"/>
            <attribute name="priority" read_only="1"/>
            <attribute name="workgroup_id" mandatory="1" must_prompt="1"/>
            <attribute name="workgroup_name"/>
            <attribute name="agent_id" mandatory="1" must_prompt="1"/>
            <attribute name="agent_name"/>
            <attribute name="agent_email" read_only="1"/>
            <attribute name="related_problem_id"/>
            <attribute name="related_problem_ref"/>
            <attribute name="related_change_id"/>
            <attribute name="related_change_ref"/>
            <attribute name="close_date" hidden="1"/>
            <attribute name="last_update" read_only="1"/>
            <attribute name="assignment_date" hidden="1"/>
            <attribute name="resolution_date" hidden="1"/>
            <attribute name="tto_escalation_deadline" hidden="1"/>
            <attribute name="ttr_escalation_deadline" read_only="1"/>
            <attribute name="closure_deadline" hidden="1"/>
            <attribute name="resolution_code" hidden="1"/>
            <attribute name="solution" hidden="1"/>
            <attribute name="user_satisfaction" hidden="1"/>
            <attribute name="user_commment" hidden="1"/>
            <attribute name="related_change_id_finalclass_recall"/>
          </flags>
          <transitions>
            <transition stimulus="ev_reassign" target="assigned">
              <actions/>
            </transition>
            <transition stimulus="ev_timeout" target="escalated_ttr">
              <actions/>
            </transition>
            <transition stimulus="ev_resolve" target="resolved">
              <actions>
                <action verb="SetResolveDate"/>
                <action verb="SetClosureDeadline"/>
              </actions>
            </transition>
          </transitions>
        </state>
        <state name="escalated_ttr">
          <flags>
            <attribute name="ref" read_only="1"/>
            <attribute name="title" read_only="1"/>
            <attribute name="description" read_only="1"/>
            <attribute name="ticket_log"/>
            <attribute name="start_date" read_only="1"/>
            <attribute name="document_list"/>
            <attribute name="ci_list"/>
            <attribute name="contact_list"/>
            <attribute name="incident_list"/>
            <attribute name="status"/>
            <attribute name="caller_id" read_only="1"/>
            <attribute name="caller_email"/>
            <attribute name="org_id" read_only="1"/>
            <attribute name="org_name"/>
            <attribute name="service_id"/>
            <attribute name="service_name"/>
            <attribute name="servicesubcategory_id"/>
            <attribute name="servicesubcategory_name"/>
            <attribute name="product"/>
            <attribute name="impact"/>
            <attribute name="urgency"/>
            <attribute name="priority" read_only="1"/>
            <attribute name="workgroup_id" mandatory="1" must_prompt="1"/>
            <attribute name="workgroup_name"/>
            <attribute name="agent_id" mandatory="1" must_prompt="1"/>
            <attribute name="agent_name"/>
            <attribute name="agent_email" read_only="1"/>
            <attribute name="related_problem_id"/>
            <attribute name="related_problem_ref"/>
            <attribute name="related_change_id"/>
            <attribute name="related_change_ref"/>
            <attribute name="close_date" hidden="1"/>
            <attribute name="last_update" read_only="1"/>
            <attribute name="assignment_date" hidden="1"/>
            <attribute name="resolution_date" hidden="1"/>
            <attribute name="tto_escalation_deadline" hidden="1"/>
            <attribute name="ttr_escalation_deadline" read_only="1"/>
            <attribute name="closure_deadline" hidden="1"/>
            <attribute name="resolution_code" hidden="1"/>
            <attribute name="solution" hidden="1"/>
            <attribute name="user_satisfaction" hidden="1"/>
            <attribute name="user_commment" hidden="1"/>
            <attribute name="related_change_id_finalclass_recall"/>
          </flags>
          <transitions>
            <transition stimulus="ev_reassign" target="escalated_ttr">
              <actions/>
            </transition>
            <transition stimulus="ev_resolve" target="resolved">
              <actions>
                <action verb="SetResolveDate"/>
                <action verb="SetClosureDeadline"/>
              </actions>
            </transition>
          </transitions>
        </state>
        <state name="frozen">
          <flags>
            <attribute name="ref" read_only="1"/>
            <attribute name="title" read_only="1"/>
            <attribute name="description" read_only="1"/>
            <attribute name="ticket_log"/>
            <attribute name="start_date" read_only="1"/>
            <attribute name="document_list"/>
            <attribute name="ci_list"/>
            <attribute name="contact_list"/>
            <attribute name="incident_list"/>
            <attribute name="status"/>
            <attribute name="caller_id" read_only="1"/>
            <attribute name="caller_email"/>
            <attribute name="org_id" read_only="1"/>
            <attribute name="org_name"/>
            <attribute name="service_id"/>
            <attribute name="service_name"/>
            <attribute name="servicesubcategory_id"/>
            <attribute name="servicesubcategory_name"/>
            <attribute name="product"/>
            <attribute name="impact"/>
            <attribute name="urgency"/>
            <attribute name="priority" read_only="1"/>
            <attribute name="workgroup_id" mandatory="1"/>
            <attribute name="workgroup_name"/>
            <attribute name="agent_id" mandatory="1"/>
            <attribute name="agent_name"/>
            <attribute name="agent_email" read_only="1"/>
            <attribute name="related_problem_id"/>
            <attribute name="related_problem_ref"/>
            <attribute name="related_change_id"/>
            <attribute name="related_change_ref"/>
            <attribute name="close_date" hidden="1"/>
            <attribute name="last_update" read_only="1"/>
            <attribute name="assignment_date" hidden="1"/>
            <attribute name="resolution_date" hidden="1"/>
            <attribute name="tto_escalation_deadline" hidden="1"/>
            <attribute name="ttr_escalation_deadline" read_only="1"/>
            <attribute name="closure_deadline" hidden="1"/>
            <attribute name="resolution_code" hidden="1"/>
            <attribute name="solution" hidden="1"/>
            <attribute name="user_satisfaction" hidden="1"/>
            <attribute name="user_commment" hidden="1"/>
            <attribute name="related_change_id_finalclass_recall"/>
          </flags>
          <transitions/>
        </state>
        <state name="resolved">
          <flags>
            <attribute name="ref" read_only="1"/>
            <attribute name="title" read_only="1"/>
            <attribute name="description" read_only="1"/>
            <attribute name="ticket_log"/>
            <attribute name="start_date" read_only="1"/>
            <attribute name="document_list"/>
            <attribute name="ci_list"/>
            <attribute name="contact_list"/>
            <attribute name="incident_list"/>
            <attribute name="status"/>
            <attribute name="caller_id" read_only="1"/>
            <attribute name="caller_email"/>
            <attribute name="org_id" read_only="1"/>
            <attribute name="org_name"/>
            <attribute name="service_id" read_only="1"/>
            <attribute name="service_name"/>
            <attribute name="servicesubcategory_id" read_only="1"/>
            <attribute name="servicesubcategory_name"/>
            <attribute name="product" read_only="1"/>
            <attribute name="impact" read_only="1"/>
            <attribute name="urgency" read_only="1"/>
            <attribute name="priority" read_only="1"/>
            <attribute name="workgroup_id" read_only="1"/>
            <attribute name="workgroup_name"/>
            <attribute name="agent_id" read_only="1"/>
            <attribute name="agent_name"/>
            <attribute name="agent_email" read_only="1"/>
            <attribute name="related_problem_id"/>
            <attribute name="related_problem_ref"/>
            <attribute name="related_change_id"/>
            <attribute name="related_change_ref"/>
            <attribute name="close_date" hidden="1"/>
            <attribute name="last_update" read_only="1"/>
            <attribute name="assignment_date" hidden="1"/>
            <attribute name="resolution_date" hidden="1"/>
            <attribute name="tto_escalation_deadline" hidden="1"/>
            <attribute name="ttr_escalation_deadline" hidden="1"/>
            <attribute name="closure_deadline" read_only="1"/>
            <attribute name="resolution_code" must_prompt="1"/>
            <attribute name="solution" must_prompt="1"/>
            <attribute name="user_satisfaction" hidden="1"/>
            <attribute name="user_commment" hidden="1"/>
            <attribute name="related_change_id_finalclass_recall"/>
          </flags>
          <transitions>
            <transition stimulus="ev_reassign" target="assigned">
              <actions/>
            </transition>
            <transition stimulus="ev_close" target="closed">
              <actions>
                <action verb="SetClosureDate"/>
              </actions>
            </transition>
          </transitions>
        </state>
        <state name="closed">
          <flags>
            <attribute name="ref" read_only="1"/>
            <attribute name="title" read_only="1"/>
            <attribute name="description" read_only="1"/>
            <attribute name="ticket_log" read_only="1"/>
            <attribute name="start_date" read_only="1"/>
            <attribute name="document_list"/>
            <attribute name="ci_list"/>
            <attribute name="contact_list"/>
            <attribute name="incident_list"/>
            <attribute name="status"/>
            <attribute name="caller_id" read_only="1"/>
            <attribute name="caller_email"/>
            <attribute name="org_id" read_only="1"/>
            <attribute name="org_name"/>
            <attribute name="service_id" read_only="1"/>
            <attribute name="service_name"/>
            <attribute name="servicesubcategory_id" read_only="1"/>
            <attribute name="servicesubcategory_name"/>
            <attribute name="product" read_only="1"/>
            <attribute name="impact" read_only="1"/>
            <attribute name="urgency" read_only="1"/>
            <attribute name="priority" read_only="1"/>
            <attribute name="workgroup_id" read_only="1"/>
            <attribute name="workgroup_name"/>
            <attribute name="agent_id" read_only="1"/>
            <attribute name="agent_name"/>
            <attribute name="agent_email" read_only="1"/>
            <attribute name="related_problem_id"/>
            <attribute name="related_problem_ref"/>
            <attribute name="related_change_id"/>
            <attribute name="related_change_ref"/>
            <attribute name="close_date" read_only="1"/>
            <attribute name="last_update" read_only="1"/>
            <attribute name="assignment_date" hidden="1"/>
            <attribute name="resolution_date" hidden="1"/>
            <attribute name="tto_escalation_deadline" hidden="1"/>
            <attribute name="ttr_escalation_deadline" hidden="1"/>
            <attribute name="closure_deadline" hidden="1"/>
            <attribute name="resolution_code" read_only="1"/>
            <attribute name="solution" read_only="1"/>
            <attribute name="user_satisfaction" must_prompt="1"/>
            <attribute name="user_commment" must_prompt="1"/>
            <attribute name="related_change_id_finalclass_recall"/>
          </flags>
          <transitions/>
        </state>
      </states>
    </lifecycle>
    <methods>
      <method name="SetClosureDeadline" static="false" access="public" type="LifecycleAction"><![CDATA[	public function SetClosureDeadline($sStimulusCode)
	{
		$iMaxWaitHours = 24;
		$this->Set('closure_deadline', time() + $iMaxWaitHours * 3600);
		return true;
	}]]></method>
      <method name="SetAssignedDate" static="false" access="public" type="LifecycleAction"><![CDATA[	public function SetAssignedDate($sStimulusCode)
	{
		$this->Set('assignment_date', time());
		return true;
	}]]></method>
      <method name="SetResolveDate" static="false" access="public" type="LifecycleAction"><![CDATA[	public function SetResolveDate($sStimulusCode)
	{
		$this->Set('resolution_date', time());
		return true;
	}]]></method>
      <method name="SetClosureDate" static="false" access="public" type="LifecycleAction"><![CDATA[	public function SetClosureDate($sStimulusCode)
	{
		$this->Set('close_date', time());
		return true;
	}]]></method>
      <method name="ComputeSLT" static="false" access="public" type="LifecycleAction"><comment><![CDATA[/**
	 * Determines the shortest SLT, for this ticket, for the given metric. Returns null is no SLT was found
	 * @param string $sMetric Type of metric 'TTO', 'TTR', etc as defined in the SLT class
	 * @return hash Array with 'SLT' => name of the SLT selected, 'value' => duration in seconds of the SLT metric, null if no SLT applies to this ticket
	 */]]></comment><![CDATA[	public function ComputeSLT($sMetric = 'TTO')
	{
		$aResult = null;
		if (MetaModel::IsValidClass('SLT'))
		{
			$sOQL = "SELECT SLT JOIN lnkSLTToSLA AS L1 ON L1.slt_id=SLT.id JOIN SLA ON L1.sla_id = SLA.id JOIN lnkContractToSLA AS L2 ON L2.sla_id = SLA.id JOIN CustomerContract ON L2.contract_id = CustomerContract.id 
					WHERE SLT.ticket_priority = :priority AND SLA.service_id = :service_id AND SLT.metric = :metric AND CustomerContract.org_id = :org_id";
			
			$oSLTSet = new DBObjectSet(DBObjectSearch::FromOQL($sOQL),
							array(),
							array(
								'priority' => $this->Get('priority'),
								'service_id' => $this->Get('service_id'),
								'metric' => $sMetric,
								'org_id' => $this->Get('org_id'),
							)
							);
							
			$iMinDuration = PHP_INT_MAX;
			$sSLTName = '';
	
			while($oSLT = $oSLTSet->Fetch())
			{
				$iDuration = (int)$oSLT->Get('value');
				$sUnit = $oSLT->Get('value_unit');
				//echo "<p>Found SLT: ".$oSLT->GetName()." - $iDuration ($sUnit)</p>\n";
				switch($sUnit)
				{
					case 'days':
					$iDuration = $iDuration * 24; // 24 hours in 1 days
					// Fall though
					
					case 'hours':
					$iDuration = $iDuration * 60; // 60 minutes in 1 hour
					// Fall though
					
					case 'minutes':
					$iDuration = $iDuration * 60;
				}
				if ($iDuration < $iMinDuration)
				{
					$iMinDuration = $iDuration;
					$sSLTName = $oSLT->GetName();
				}
			}
			if ($iMinDuration == PHP_INT_MAX)
			{
				$aResult = null;
			}
			else
			{
				$aResult = array('SLT' => $sSLTName, 'value' => $iMinDuration);
			}
		}
		return $aResult;
	}]]></method>
      <method name="ComputePriority" static="false" access="public" type="LifecycleAction"><comment><![CDATA[/**
	 * Compute the priority of the ticket based on its impact and urgency
	 * @return integer The priority of the ticket 1(high) .. 3(low)
	 */]]></comment><![CDATA[	public function ComputePriority()
	{
		// priority[impact][urgency]
		$aPriorities = array(
			// single person
			1 => array(
					1 => 1,
					2 => 1,
					3 => 2,
			),
			// a group
			2 => array(
				1 => 1,
				2 => 2,
				3 => 3,
			),
			// a departement!
			3 => array(
					1 => 2,
					2 => 3,
					3 => 3,
			),
		);
		$iPriority = $aPriorities[(int)$this->Get('impact')][(int)$this->Get('urgency')];
		return $iPriority;		
	}]]></method>
      <method name="ComputeValues" static="false" access="public" type="Overload-DBObject"><![CDATA[	public function ComputeValues()
	{
		// Compute the priority of the ticket
		$this->Set('priority', $this->ComputePriority());
		
		// Compute the SLA deadlines, if any is applicable to this ticket
		$aSLT = $this->ComputeSLT('TTO');
		if ($aSLT != null)
		{
			$oStartDate = new DateTime($this->Get('start_date'));
			$oDeadline = SLAComputation::GetDeadline($this, $aSLT['value'], $oStartDate);		
			$this->Set('tto_escalation_deadline', $oDeadline->format('U'));
		}
		else
		{
			$this->Set('tto_escalation_deadline', null);
		}
		$aSLT = $this->ComputeSLT('TTR');
		if ($aSLT != null)
		{
			$oStartDate = new DateTime($this->Get('start_date'));
			$oDeadline = SLAComputation::GetDeadline($this, $aSLT['value'], $oStartDate);		
			$this->Set('ttr_escalation_deadline', $oDeadline->format('U'));
		}
		else
		{
			$this->Set('ttr_escalation_deadline', null);
		}
	}]]></method>
      <method name="GetHilightClass" static="false" access="public" type="Overload-iDisplay"><comment><![CDATA[/**
	 * Determines if the ticket must be hilighted in the list, if we're about to miss a SLA for instance
	 */]]></comment><![CDATA[	public function GetHilightClass()
	{
		$sHilightClass = '';
		switch($this->GetState())
		{
			case 'new':
			$oEscalationDeadline = $this->Get('tto_escalation_deadline');
			if ($oEscalationDeadline != null)
			{
				// A SLA is running
				$iStartDate = AttributeDateTime::GetAsUnixSeconds($this->Get('start_date'));
				$iEscalationDeadline = AttributeDateTime::GetAsUnixSeconds($oEscalationDeadline);
				$ratio = ($iEscalationDeadline - time())/($iEscalationDeadline - $iStartDate);
				if ($ratio <= 0)
				{
					$sHilightClass = HILIGHT_CLASS_CRITICAL;
				}
				else if ($ratio <= 0.25)
				{
					$sHilightClass = HILIGHT_CLASS_WARNING;
				}
			}
			break;
			
			case 'assigned':
			$oEscalationDeadline = $this->Get('ttr_escalation_deadline');
			if ($oEscalationDeadline != null)
			{
				// A SLA is running
				$iStartDate = AttributeDateTime::GetAsUnixSeconds($this->Get('start_date'));
				$iEscalationDeadline = AttributeDateTime::GetAsUnixSeconds($oEscalationDeadline);
				$ratio = ($iEscalationDeadline - time())/($iEscalationDeadline - $iStartDate);
				if ($ratio <= 0)
				{
					$sHilightClass = HILIGHT_CLASS_CRITICAL;
				}
				else if ($ratio <= 0.25)
				{
					$sHilightClass = HILIGHT_CLASS_WARNING;
				}
			}
			break;
			
			case 'escalated_tto':
			case 'escalated_ttr':
			$sHilightClass = HILIGHT_CLASS_CRITICAL;
			break;
		}
		return $sHilightClass;
	}]]></method>
      <method name="OnInsert" static="false" access="protected" type="Overload-DBObject"><![CDATA[	protected function OnInsert()
	{
		$this->Set('last_update', time());
	}]]></method>
      <method name="OnUpdate" static="false" access="protected" type="Overload-DBObject"><![CDATA[	protected function OnUpdate()
	{
		$this->Set('last_update', time());
	}]]></method>
    </methods>
    <presentation>
      <details>
        <items>
          <item>ref</item>
          <item>title</item>
          <item>org_id</item>
          <item>start_date</item>
          <item>tto_escalation_deadline</item>
          <item>ttr_escalation_deadline</item>
          <item>closure_deadline</item>
          <item>document_list</item>
          <item>ci_list</item>
          <item>contact_list</item>
          <item>status</item>
          <item>caller_id</item>
          <item>service_id</item>
          <item>servicesubcategory_id</item>
          <item>product</item>
          <item>impact</item>
          <item>urgency</item>
          <item>priority</item>
          <item>workgroup_id</item>
          <item>agent_id</item>
          <item>agent_email</item>
          <item>related_problem_id</item>
          <item>related_change_id</item>
          <item>close_date</item>
          <item>last_update</item>
          <item>assignment_date</item>
          <item>resolution_code</item>
          <item>solution</item>
          <item>user_satisfaction</item>
          <item>user_commment</item>
        </items>
      </details>
      <search>
        <items>
          <item>finalclass</item>
          <item>ref</item>
          <item>title</item>
          <item>org_id</item>
          <item>start_date</item>
          <item>status</item>
          <item>caller_id</item>
          <item>service_id</item>
          <item>servicesubcategory_id</item>
          <item>product</item>
          <item>impact</item>
          <item>urgency</item>
          <item>priority</item>
          <item>workgroup_id</item>
          <item>agent_id</item>
          <item>agent_email</item>
          <item>close_date</item>
          <item>resolution_code</item>
          <item>solution</item>
          <item>user_satisfaction</item>
          <item>user_commment</item>
        </items>
      </search>
      <list>
        <items>
          <item>finalclass</item>
          <item>title</item>
          <item>org_id</item>
          <item>start_date</item>
          <item>status</item>
          <item>caller_id</item>
          <item>service_id</item>
          <item>priority</item>
          <item>workgroup_id</item>
          <item>agent_id</item>
          <item>last_update</item>
        </items>
      </list>
    </presentation>
  </class>
  <class name="lnkTicketToDoc" category="bizmodel,searchable,incidentmgmt,requestmgmt,changemgmt,problemmgmt,lnkticket" parent="cmdbAbstractObject" abstract="false" key_type="autoincrement" is_link="1" db_table="lnktickettodoc" db_key_field="id" db_final_class_field="">
    <properties>
      <naming format="%1$s">
        <attributes>
          <attribute name="ticket_id"/>
        </attributes>
      </naming>
      <display_template></display_template>
      <icon></icon>
      <reconciliation>
        <attributes>
          <attribute name="ticket_id"/>
          <attribute name="document_id"/>
        </attributes>
      </reconciliation>
    </properties>
    <fields>
      <field name="ticket_id" type="ExternalKey" target_class="Ticket" jointype="" sql="ticket_id" is_null_allowed="false" on_target_delete="DEL_AUTO"/>
      <field name="ticket_ref" type="ExternalField" extkey_attcode="ticket_id" target_attcode="ref"/>
      <field name="document_id" type="ExternalKey" target_class="Document" jointype="" sql="document_id" is_null_allowed="false" on_target_delete="DEL_AUTO"/>
      <field name="document_name" type="ExternalField" extkey_attcode="document_id" target_attcode="name"/>
    </fields>
    <methods/>
    <presentation>
      <details>
        <items>
          <item>ticket_id</item>
          <item>document_id</item>
        </items>
      </details>
      <search>
        <items>
          <item>ticket_id</item>
          <item>document_id</item>
        </items>
      </search>
      <list>
        <items>
          <item>ticket_id</item>
          <item>document_id</item>
        </items>
      </list>
    </presentation>
  </class>
  <class name="lnkTicketToContact" category="bizmodel,searchable,incidentmgmt,requestmgmt,changemgmt,problemmgmt,lnkticket" parent="cmdbAbstractObject" abstract="false" key_type="autoincrement" is_link="1" db_table="lnktickettocontact" db_key_field="id" db_final_class_field="">
    <properties>
      <naming format="%1$s">
        <attributes>
          <attribute name="ticket_id"/>
        </attributes>
      </naming>
      <display_template></display_template>
      <icon></icon>
      <reconciliation>
        <attributes>
          <attribute name="ticket_id"/>
          <attribute name="contact_id"/>
        </attributes>
      </reconciliation>
    </properties>
    <fields>
      <field name="ticket_id" type="ExternalKey" target_class="Ticket" jointype="" sql="ticket_id" is_null_allowed="false" on_target_delete="DEL_AUTO"/>
      <field name="ticket_ref" type="ExternalField" extkey_attcode="ticket_id" target_attcode="ref"/>
      <field name="contact_id" type="ExternalKey" target_class="Contact" jointype="" sql="contact_id" is_null_allowed="false" on_target_delete="DEL_AUTO"/>
      <field name="contact_name" type="ExternalField" extkey_attcode="contact_id" target_attcode="name"/>
      <field name="contact_email" type="ExternalField" extkey_attcode="contact_id" target_attcode="email"/>
      <field name="role" type="String" sql="role" default_value="" is_null_allowed="true"/>
    </fields>
    <methods/>
    <presentation>
      <details>
        <items>
          <item>ticket_id</item>
          <item>contact_id</item>
          <item>contact_email</item>
          <item>role</item>
        </items>
      </details>
      <search>
        <items>
          <item>ticket_id</item>
          <item>contact_id</item>
          <item>contact_email</item>
          <item>role</item>
        </items>
      </search>
      <list>
        <items>
          <item>ticket_id</item>
          <item>contact_id</item>
          <item>contact_email</item>
          <item>role</item>
        </items>
      </list>
    </presentation>
  </class>
  <class name="lnkTicketToCI" category="bizmodel,searchable,incidentmgmt,requestmgmt,changemgmt,problemmgmt,lnkticket" parent="cmdbAbstractObject" abstract="false" key_type="autoincrement" is_link="1" db_table="lnktickettoci" db_key_field="id" db_final_class_field="">
    <properties>
      <naming format="%1$s">
        <attributes>
          <attribute name="ticket_id"/>
        </attributes>
      </naming>
      <display_template></display_template>
      <icon></icon>
      <reconciliation>
        <attributes>
          <attribute name="ticket_id"/>
          <attribute name="ci_id"/>
        </attributes>
      </reconciliation>
    </properties>
    <fields>
      <field name="ticket_id" type="ExternalKey" target_class="Ticket" jointype="" sql="ticket_id" is_null_allowed="false" on_target_delete="DEL_AUTO"/>
      <field name="ticket_ref" type="ExternalField" extkey_attcode="ticket_id" target_attcode="ref"/>
      <field name="ci_id" type="ExternalKey" target_class="FunctionalCI" jointype="" sql="ci_id" is_null_allowed="false" on_target_delete="DEL_AUTO"/>
      <field name="ci_name" type="ExternalField" extkey_attcode="ci_id" target_attcode="name"/>
      <field name="ci_status" type="ExternalField" extkey_attcode="ci_id" target_attcode="status"/>
      <field name="impact" type="String" sql="impact" default_value="" is_null_allowed="true"/>
    </fields>
    <methods/>
    <presentation>
      <details>
        <items>
          <item>ticket_id</item>
          <item>ci_id</item>
          <item>impact</item>
          <item>ci_status</item>
        </items>
      </details>
      <search>
        <items>
          <item>ticket_id</item>
          <item>ci_id</item>
          <item>ci_status</item>
        </items>
      </search>
      <list>
        <items>
          <item>ticket_id</item>
          <item>ci_id</item>
          <item>impact</item>
          <item>ci_status</item>
        </items>
      </list>
    </presentation>
  </class>
</classes>
